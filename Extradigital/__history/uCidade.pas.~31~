unit uCidade;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, cxGraphics, cxLookAndFeels,
  cxLookAndFeelPainters, Vcl.Menus, Vcl.StdCtrls, cxButtons, Vcl.ExtCtrls,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, Data.DB, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, cxControls, cxStyles,
  cxCustomData, cxFilter, cxData, cxDataStorage, cxEdit,
  cxNavigator, cxDBData, cxGridLevel, cxGridCustomTableView, cxGridTableView,
  cxGridDBTableView, cxClasses, cxGridCustomView, cxGrid, Vcl.ComCtrls,
  cxContainer, cxTextEdit,
  cxDataControllerConditionalFormattingRulesManagerDialog,Vcl.Grids, Vcl.DBGrids,
  dxSkinsCore, dxSkinBlack, dxSkinBlue, dxSkinBlueprint, dxSkinCaramel,
  dxSkinCoffee, dxSkinDarkroom, dxSkinDarkSide, dxSkinDevExpressDarkStyle,
  dxSkinDevExpressStyle, dxSkinFoggy, dxSkinGlassOceans, dxSkinHighContrast,
  dxSkiniMaginary, dxSkinLilian, dxSkinLiquidSky, dxSkinLondonLiquidSky,
  dxSkinMcSkin, dxSkinMetropolis, dxSkinMetropolisDark, dxSkinMoneyTwins,
  dxSkinOffice2007Black, dxSkinOffice2007Blue, dxSkinOffice2007Green,
  dxSkinOffice2007Pink, dxSkinOffice2007Silver, dxSkinOffice2010Black,
  dxSkinOffice2010Blue, dxSkinOffice2010Silver, dxSkinOffice2013DarkGray,
  dxSkinOffice2013LightGray, dxSkinOffice2013White, dxSkinOffice2016Colorful,
  dxSkinOffice2016Dark, dxSkinPumpkin, dxSkinSeven, dxSkinSevenClassic,
  dxSkinSharp, dxSkinSharpPlus, dxSkinSilver, dxSkinSpringtime, dxSkinStardust,
  dxSkinSummer2008, dxSkinTheAsphaltWorld, dxSkinTheBezier,
  dxSkinsDefaultPainters, dxSkinValentine, dxSkinVisualStudio2013Blue,
  dxSkinVisualStudio2013Dark, dxSkinVisualStudio2013Light, dxSkinVS2010,
  dxSkinWhiteprint, dxSkinXmas2008Blue;

type
  TfrmCidade = class(TForm)
    pnBotoes: TPanel;
    SpeedButtonInsert: TcxButton;
    SpeedButtonDelete: TcxButton;
    SpeedButtonEdit: TcxButton;
    SpeedButtonPost: TcxButton;
    SpeedButtonCancel: TcxButton;
    qryCidade: TFDQuery;
    dsCidade: TDataSource;
    pgCidade: TPageControl;
    tbsRegiao: TTabSheet;
    tbsManutencao: TTabSheet;
    pnManutencao: TPanel;
    lbCidade: TLabel;
    lbUF: TLabel;
    edCidade: TEdit;
    grdCidade: TDBGrid;
    qryAux: TFDQuery;
    qryEstado: TFDQuery;
    edUF: TComboBox;
    procedure FormShow(Sender: TObject);
    procedure grdGC0218DBTableView1DblClick(Sender: TObject);
    procedure SpeedButtonInsertClick(Sender: TObject);
    procedure SpeedButtonDeleteClick(Sender: TObject);
    procedure SpeedButtonEditClick(Sender: TObject);
    procedure SpeedButtonCancelClick(Sender: TObject);
    procedure SpeedButtonPostClick(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
  private
    { Private declarations }
    Opr,Comando:String;
    procedure LimpaTela;
    procedure AjustaBotoes;
    procedure AtribuiValores;
    procedure CarregaUF;
  public
    { Public declarations }
  end;

var
  frmCidade: TfrmCidade;

implementation

{$R *.dfm}

uses uMain;

procedure TfrmCidade.LimpaTela;
var i:Integer;
begin
  for i := 0 to componentCount-1 do begin
    if (Components[i] is TEdit) then
       TEdit(Components[i]).Clear;
    if (Components[i] is TComboBox) then
       TComboBox(Components[i]).Clear;

  end;
end;

procedure TfrmCidade.SpeedButtonCancelClick(Sender: TObject);
begin
  LimpaTela;
  Opr:='';
  AjustaBotoes;
  pgCidade.ActivePageIndex:=0;
  grdCidade.SetFocus;
end;

procedure TfrmCidade.SpeedButtonDeleteClick(Sender: TObject);
begin
  if not qryCidade.IsEmpty then begin
    if MessageDlg('Confirma a exclusão ?',mtConfirmation,[mbYes,mbNo],0) = mrYes then begin
      try
        Comando:= 'DELETE FROM CADCIDADE WHERE IDCIDADE = ''' +qryCidade.FieldByName('IDCIDADE').AsString+'''';
        qryAux.Close;
        qryAux.SQL.Text:=Comando;
        qryAux.ExecSQL;

      finally
        qryCidade.Close;
        qryCidade.Open();
        Opr:='';
        AjustaBotoes;
        pgCidade.ActivePageIndex:=0;
      end;
    end;
  end;
end;

procedure TfrmCidade.SpeedButtonEditClick(Sender: TObject);
begin
  if not qryCidade.IsEmpty then begin
    Opr:='E';
    AjustaBotoes;
    if pgCidade.ActivePageIndex = 0 then begin
      LimpaTela;
      AtribuiValores;
    end;
    pgCidade.ActivePageIndex:=1;
    edCidade.SetFocus;
  end;
end;

procedure TfrmCidade.SpeedButtonInsertClick(Sender: TObject);
begin
  pgCidade.ActivePageIndex := 1;
  LimpaTela;
  Opr:='I';
  AjustaBotoes;
  edCidade.SetFocus;
end;

procedure TfrmCidade.SpeedButtonPostClick(Sender: TObject);
var strCodigo, strUF:string;
begin
  if Length(Trim(edCidade.Text)) = 0 then begin
    MessageDlg('Cidade não informado',mtInformation,[mbOK],0);
    exit;
  end;
  if Length(Trim(edUF.Text)) = 0 then begin
    MessageDlg('UF não informada',mtInformation,[mbOK],0);
    exit;
  end;

  qryAux.Close;
  qryAux.Open('SELECT IDUF FROM CADUF WHERE SGESTADO = '''+edUF.Text+'''');
  strUF:=qryAux.FieldByName('IDUF').AsString;


  if Opr = 'I' then begin begin
    qryAux.Close;
    qryAux.SQL.Text:='SELECT COUNT(*)+1 QTD FROM CADCIDADE';
    qryAux.Open;
    strCodigo:=qryAux.FieldByName('QTD').AsString;
    Comando:='INSERT INTO CADCIDADE (IDCIDADE, NMCIDADE, IDUF) VALUES ('''+strCodigo+''','''+edCidade.Text+''','''+strUF+''')';
  end;
  end
  else begin
    Comando:=' UPDATE CADCIDADE SET '+
             ' NMCIDADE = '''+edCidade.Text+''', '+
             ' IDUF = '''+strUF+''' '+
             ' WHERE IDCIDADE = '''+qryEstado.FieldByName('IDCIDADE').AsString+'''';
  end;
  qryAux.Close;
  qryAux.SQL.Text:=Comando;
  qryAux.ExecSQL;
  qryEstado.Close;
  qryEstado.Open();
  pgCidade.ActivePageIndex:=0;
  grdCidade.SetFocus;
  Opr:='';
  AjustaBotoes;
end;

procedure TfrmCidade.AjustaBotoes;
begin
  if (Opr = 'I') then begin
    SpeedButtonInsert.Enabled:=False;
    SpeedButtonDelete.Enabled:=False;
    SpeedButtonEdit.Enabled:=False;
    SpeedButtonPost.Enabled:=True;
    SpeedButtonCancel.Enabled:=True;
    CarregaUF;
    pnManutencao.Enabled:=True;
  end
  else if Opr = 'E' then begin
    SpeedButtonInsert.Enabled:=False;
    SpeedButtonDelete.Enabled:=False;
    SpeedButtonEdit.Enabled:=False;
    SpeedButtonPost.Enabled:=True;
    SpeedButtonCancel.Enabled:=True;
    CarregaUF;
    pnManutencao.Enabled:=True;
  end
  else if Opr = 'C' then begin
    SpeedButtonInsert.Enabled:=True;
    SpeedButtonDelete.Enabled:=True;
    SpeedButtonEdit.Enabled:=True;
    SpeedButtonPost.Enabled:=False;
    SpeedButtonCancel.Enabled:=True;
    pnManutencao.Enabled:=False;
  end
  else begin
    SpeedButtonInsert.Enabled:=True;
    SpeedButtonDelete.Enabled:=not qryEstado.IsEmpty;
    SpeedButtonEdit.Enabled:=not qryEstado.IsEmpty;
    SpeedButtonPost.Enabled:=False;
    SpeedButtonCancel.Enabled:=False;
    pnManutencao.Enabled:=True;
  end;
end;

procedure TfrmCidade.AtribuiValores;
begin
  edCidade.Text:=qryCidade.FieldByName('NMCIDADE').AsString;
  edUF.Text:=qryCidade.FieldByName('SGESTADO').AsString;
end;

procedure TfrmCidade.CarregaUF;
begin
  qryEstado.Close;
  qryEstado.Open;
  if not qryEstado.IsEmpty then begin
    qryEstado.First;
    while not qryEstado.Eof do begin
      edUF.Items.Add(qryEstado.FieldByName('sgestado').AsString);
      qryEstado.Next;
    end;
  end;

end;

procedure TfrmCidade.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    Keybd_event(VK_TAB, 0, 0, 0);
end;

procedure TfrmCidade.FormShow(Sender: TObject);
begin
  qryCidade.Close;
  qryCidade.Open;
  pgCidade.ActivePageIndex:=0;
  grdCidade.SetFocus;
  Opr:='';
  AjustaBotoes;
end;

procedure TfrmCidade.grdGC0218DBTableView1DblClick(Sender: TObject);
begin
  if not qryEstado.IsEmpty then begin
    Opr:='C';
    AjustaBotoes;
    pgCidade.ActivePageIndex:=1;
    LimpaTela;
    AtribuiValores;
  end;
end;


end.
